- name: Remount tmpfs
  ansible.posix.mount:
    path: "/"
    state: "remounted"
    opts: "size=1G"
    fstype: "tmpfs"

- name: Download, decompress and extract Arch Linux boostrap image
  ansible.builtin.shell:
    cmd: >
      set -o pipefail

      curl "https://geo.mirror.pkgbuild.com/iso/{{ install_arch_bootstrap_version }}/archlinux-bootstrap-x86_64.tar.zst" |
      zstd -d --stdout | tar xv --exclude=root.x86_64/usr/share/locale --exclude=root.x86_64/usr/share/man -C /tmp
    executable: /bin/bash
    creates: /tmp/root.x86_64

- name: Copy resolv.conf to bootstrap chroot
  ansible.builtin.copy:
    remote_src: true
    src: /etc/resolv.conf
    dest: /tmp/root.x86_64/etc/resolv.conf
    owner: root
    group: root
    mode: "u=rw,g=r,o=r"

- name: Mount /proc to bootstrap chroot
  ansible.posix.mount:
    src: /proc
    path: /tmp/root.x86_64/proc
    state: mounted
    fstype: proc
    opts: rbind

- name: Mount /sys to bootstrap chroot
  ansible.posix.mount:
    src: /sys
    path: /tmp/root.x86_64/sys
    state: mounted
    fstype: sysfs
    opts: rbind

- name: Mount /dev to bootstrap chroot
  ansible.posix.mount:
    src: /dev
    path: /tmp/root.x86_64/dev
    state: mounted
    fstype: udev
    opts: rbind
