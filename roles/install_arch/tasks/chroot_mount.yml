- name: Set chroot path
  ansible.builtin.set_fact:
    chroot_path: "/mnt"

- name: Mount the root filesystem
  when:
    - filesystem == "ext4"
  ansible.posix.mount:
    src: "{{ system_disks[0] }}{{ 'p' if 'nvme' in system_disks[0] }}{{ root_partno }}"
    path: "{{ chroot_path }}"
    state: mounted
    fstype: ext4

- name: Create the efi mountpoint
  when:
    - ansible_virtualization_role == 'host'
  ansible.builtin.file:
    path: "{{ chroot_path }}/efi"
    state: directory
    mode: '0755'

- name: Mount the efi filesystem
  when:
    - ansible_virtualization_role == 'host'
  ansible.posix.mount:
    src: "{{ system_disks[0] }}{{ 'p2' if 'nvme' in system_disks[0] else '2' }}"
    path: "{{ chroot_path }}/efi"
    state: mounted
    fstype: vfat

- name: Mount chroot to bootstrap chroot
  when:
    - filesystem == "ext4"
  ansible.posix.mount:
    src: "{{ chroot_path }}"
    path: /tmp/root.x86_64/mnt
    state: mounted
    fstype: ext4
    opts: rbind

- name: Mount /proc to new chroot
  ansible.posix.mount:
    src: /proc
    path: "{{ chroot_path }}/proc"
    state: mounted
    fstype: proc
    opts: rbind

- name: Mount /sys to new chroot
  ansible.posix.mount:
    src: /sys
    path: "{{ chroot_path }}/sys"
    state: mounted
    fstype: sysfs
    opts: rbind

- name: Mount /dev to new chroot
  ansible.posix.mount:
    src: /dev
    path: "{{ chroot_path }}/dev"
    state: mounted
    fstype: udev
    opts: rbind
